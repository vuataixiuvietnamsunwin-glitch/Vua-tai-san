<!DOCTYPE html>
<html lang="vi">
<head>
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta charset="UTF-8">
<title>TR√ôM SƒÇN WIN</title>

<style>
.bowl-timer{
 position:absolute;
 left:50%;
 transform:translateX(-50%);
 bottom:8px;          /* üëà n√¢ng l√™n */
 font-size:14px;
 font-weight:bold;
 color:#ffd700;
 background:rgba(0,0,0,.7);
 padding:3px 10px;
 border-radius:12px;
 pointer-events:none;
 user-select:none;
 z-index:20;
}
/* ===== ROADMAP T√ÄI X·ªàU ===== */
.grid{
 display:grid;
 grid-template-columns:repeat(15, 1fr);
 grid-template-rows:repeat(5, 1fr);
 gap:4px;
 background:#2b0035;
 padding:8px;
 border-radius:12px;
 width:100%;
 max-width:100%;
 aspect-ratio: 15 / 5;
 box-sizing:border-box;
}

.cell{
 width:100%;
 height:100%;
 border:1px solid rgba(255,255,255,.15);
 display:flex;
 justify-content:center;
 align-items:center;
}

.ball{
 width:70%;
 height:70%;
 border-radius:50%;
 display:flex;
 justify-content:center;
 align-items:center;
 font-weight:bold;
 font-size:12px;
}

.ball.tai{
 background:#000;
 color:#fff;
 border:2px solid #d4af37;
}

.ball.xiu{
 background:#fff;
 color:#000;
 border:2px solid #d4af37;
}

.stat{
 padding:6px 14px;
 border-radius:14px;
 font-size:14px;
 font-weight:bold;
 min-width:80px;
 text-align:center;
}
.stat.tai{
 background:#000;
 color:#fff;
 border:2px solid #d4af37;
}
.stat.xiu{
 background:#fff;
 color:#000;
 border:2px solid #d4af37;
}
.win-float{
 position:absolute;
 font-size:16px;
 font-weight:bold;
 color:#00ff99;
 text-shadow:0 0 10px rgba(0,255,200,.8), 0 0 20px rgba(0,255,200,.5);
 animation: floatWin 4s ease-out forwards;
 pointer-events:none;
 z-index:9999;
 white-space:nowrap;
}

.win-float.jackpot{
 color:#ffd700;
 text-shadow:0 0 12px rgba(255,215,0,.9), 0 0 25px rgba(255,215,0,.7);
 font-size:16px;
}

@keyframes floatWin{
 0%{
  transform: translate(-50%, 0) scale(0.7);
  opacity:0;
 }
 15%{
  transform: translate(-50%, -40px) scale(1);
  opacity:1;
 }
 85%{
  transform: translate(-50%, -40px) scale(1);
  opacity:1;
 }
 100%{
  transform: translate(-50%, -60px) scale(1.1);
  opacity:0;
 }
}
.coin{
 position:absolute;
 width:20px;
 height:20px;
 border-radius:50%;
 background:radial-gradient(circle at 30% 30%, #fff6a0, #ffcc00 50%, #cc9900);
 box-shadow:
  inset -2px -2px 4px rgba(255,255,255,.6),
  inset 2px 2px 4px rgba(0,0,0,.3),
  0 4px 8px rgba(0,0,0,.5);
 pointer-events:none;
 z-index:9999;
}

@keyframes coinStreamDrop {
 from { transform: translateY(-80px); opacity: 1; }
 to   { transform: translateY(var(--drop)); opacity: 1; }
}

@keyframes coinFlowToBox {
 to {
  transform: translate(var(--dx), var(--dy)) scale(0.3);
  opacity: 0;
 }
}
.dice3d {
 width: 60px;
 height: 60px;
 position: relative;
 transform-style: preserve-3d;
 transition: transform 0.6s ease-out;
}

.rolling {
 animation: roll3d 0.7s linear infinite;
}

.face {
 position: absolute;
 width: 60px;
 height: 60px;
 background: linear-gradient(145deg, #ff3a3a, #b30000);
 border-radius: 10px;
 box-shadow:
  inset -4px -4px 8px rgba(0,0,0,.4),
  inset 4px 4px 8px rgba(255,255,255,.3),
  0 10px 20px rgba(0,0,0,.6);
 display: flex;
 flex-wrap: wrap;
 justify-content: center;
 align-items: center;
}

.dot {
 width: 10px;
 height: 10px;
 background: white;
 border-radius: 50%;
 margin: 4px;
 box-shadow: inset -1px -1px 2px rgba(0,0,0,.4);
}

/* v·ªã tr√≠ c√°c m·∫∑t */
.f1 { transform: rotateY(0deg) translateZ(30px); }
.f2 { transform: rotateY(90deg) translateZ(30px); }
.f3 { transform: rotateY(180deg) translateZ(30px); }
.f4 { transform: rotateY(-90deg) translateZ(30px); }
.f5 { transform: rotateX(90deg) translateZ(30px); }
.f6 { transform: rotateX(-90deg) translateZ(30px); }

@keyframes roll3d {
 0% { transform: rotateX(0deg) rotateY(0deg); }
 100% { transform: rotateX(720deg) rotateY(1080deg); }
}
#sessionStat{
 color:#000;
 font-size:13px;
 font-weight:bold;
 margin-bottom:6px;
 text-align:left;
}
#sessionHistoryBox{
 background:#3a3a4a

; /* nh·∫°t h∆°n */
 border-radius:10px;
 padding:10px;
 margin-top:10px;
}

#sessionCanvas{
 background:#3a3a4a
; /* n·ªÅn s√°ng ƒë·ªÉ th·∫•y ch·∫•m ƒëen */
 border-radius:8px;
}

.hidden{
 display:none;
}
body{background:#0b0f1a;color:#fff;font-family:Arial;text-align:center}
.board{max-width:420px;margin:auto;padding:15px;position:relative}
.title{font-size:26px;font-weight:bold;color:#ffd700;margin-bottom:8px}
.top-left{position:absolute;left:10px;top:10px}
.top-right{position:absolute;right:10px;top:10px}
/* ===== ZOOM TI·ªÄN ===== */
.money-pop{
 animation: moneyPop 0.25s ease-out;
}

@keyframes moneyPop{
 0%   { transform: scale(1); }
 40%  { transform: scale(1.18); }
 100% { transform: scale(1); }
}
.money{font-size:18px;margin-top:25px}
.dice-wrap{
 position:absolute;
 inset:0;
}
.dice-wrap{
 position:absolute;
 inset:0;
 pointer-events:none;
}

.dice-wrap .dice3d{
 position:absolute;
}
.dice-wrap .dice3d{
 position:absolute;
}
.bet-area{display:flex;justify-content:space-between;margin:10px 0}
.side{width:45%;padding:10px;border-radius:10px}
.tai{background:#3b2f1a}
.xiu{background:#1a3b2f}
.dice-wrap{
 position:absolute;
 inset:0;
 display:grid;
 grid-template-columns: repeat(3, auto);
 grid-template-rows: repeat(2, auto);
 justify-content:center;
 align-items:center;
 gap:10px;
}
.center{
 position:relative;
 overflow:hidden;
}
.center{
 width:160px;
 height:160px;
 border-radius:50%;
 background:#222;
 margin:10px auto;
 position:relative;
 display:flex;
 align-items:center;
 justify-content:center;
 overflow:hidden;
}
.countdown{
 font-size:42px;
 font-weight:bold;
 color:#ffd700;
}

.dice{
 width:36px;height:36px;background:#c00;border-radius:6px;
 display:grid;grid-template-columns:repeat(3,1fr);
 grid-template-rows:repeat(3,1fr);padding:5px;
transform: rotate(45deg);
}
.dot{width:6px;height:6px;background:#fff;border-radius:50%;margin:auto;opacity:0;
transform: rotate(-45deg);
}

button,input{padding:8px;margin:4px}

.history{display:flex;justify-content:center;gap:5px;margin-top:8px}
.dotH{width:12px;height:12px;border-radius:50%;border:1px solid #aaa}
.dotH.tai{background:#000}
.dotH.xiu{background:#fff}

.win{color:#0f0}
.lose{color:#f33}
.lock{color:#f55;font-weight:bold}

.blink-tai{animation:blinkTai 0.6s ease-in-out 4}
.blink-xiu{animation:blinkXiu 0.6s ease-in-out 4}
@keyframes blinkTai{0%,100%{color:#ffd700}50%{color:#fff}}
@keyframes blinkXiu{0%,100%{color:#9ff}50%{color:#fff}}

#chatBox{
 background:#111;border-radius:8px;padding:8px;height:160px;
 overflow-y:auto;font-size:13px;text-align:left;margin-top:10px
}
.chat-msg{margin:2px 0}
.nick{color:#6cf;font-weight:bold}
.predict{color:#ff0}
.winChat{color:#7f7}
.loseChat{color:#f77}
.admin{color:#ff6;font-weight:bold}
.me{color:#6f6}

.chat-input{display:flex;gap:6px;margin-top:6px}
.chat-input input{flex:1;border-radius:6px;border:none;padding:8px}

/* L·ªäCH S·ª¨ C∆Ø·ª¢C */
#betHistoryBox{
 display:none;
 background:#111;
 border-radius:8px;
 padding:8px;
 margin-top:10px;
 max-height:220px;
 overflow-y:auto;
 font-size:13px
}
#betHistoryBox table{width:100%;border-collapse:collapse}
#betHistoryBox th,#betHistoryBox td{
 border-bottom:1px solid #333;
 padding:4px;
 text-align:center
}
.flash{
 animation: flash 0.6s ease-in-out 3;
}

@keyframes flash{
 0%{opacity:1}
 50%{opacity:0.3}
 100%{opacity:1}
}
    /* NH·∫§P NH√ÅY √î C·ª¨A TH·∫ÆNG */
.flash-win{
 animation: flashWin 0.5s ease-in-out 10;
}

@keyframes flashWin{
 0%{transform:scale(1);box-shadow:0 0 0 rgba(255,255,255,0)}
 50%{transform:scale(1.05);box-shadow:0 0 20px rgba(255,255,255,0.6)}
 100%{transform:scale(1);box-shadow:0 0 0 rgba(255,255,255,0)}
}
    /* B·∫¢NG X·∫æP H·∫†NG */
#rankBox{
 display:none;
 background:#140b0b;
 border-radius:10px;
 padding:10px;
 margin-top:10px;
 font-size:14px;
}

.rank-title{
 color:#ffd700;
 font-weight:bold;
 margin-bottom:6px;
}

#rankBox table{
 width:100%;
 border-collapse:collapse;
}

#rankBox th,#rankBox td{
 border-bottom:1px solid #333;
 padding:6px;
 text-align:center;
}

.rank-me{
 color:#6f6;
 font-weight:bold;
}
.bowl.auto-open{
 transform: translateY(-140px) scale(0.9);
 opacity:0;
 transition: all 0.5s ease;
 pointer-events:none;
}
.bowl{
 position:absolute;
 width:200px;
 height:200px;
 border-radius:50%;
 background:#5a3a1a;
 display:flex;
 align-items:center;
 justify-content:center;
 font-size:40px;
 z-index:10;
 left:0;
 top:0;
 touch-action:none;
 cursor:grab;
}
.bowl:active{cursor:grabbing;}

.bowl.open{
 transform: translateY(-120px);
 opacity:0;
}

.hidden{
 display:none;
}
.flash-box{
 animation: flashBox 0.6s ease-in-out 7;
}

@keyframes flashBox{
 0%{filter:brightness(1)}
 50%{filter:brightness(1.6)}
 100%{filter:brightness(1)}
}
:root{
 --dice-size: 40px;
 --dice-depth: calc(var(--dice-size) / 2);
 --dot-size: calc(var(--dice-size) / 5);
}

.dice3d{
 width:var(--dice-size);
 height:var(--dice-size);
 position:relative;
 transform-style:preserve-3d;
 animation: roll 0.6s linear infinite;
}
#coinLayer{
 position:absolute;
 inset:0;
 overflow:hidden;
 pointer-events:none;
}
.face{
 position:absolute;
 width:var(--dice-size);
 height:var(--dice-size);
 background:#c00;
 border-radius:calc(var(--dice-size)/6);
 display:grid;
 grid-template-columns:repeat(3,1fr);
 grid-template-rows:repeat(3,1fr);
 padding:calc(var(--dice-size)/10);
 box-shadow: inset -4px -4px 8px rgba(0,0,0,.4),
             inset 4px 4px 8px rgba(255,255,255,.3);
}

.dot{
 width:var(--dot-size);
 height:var(--dot-size);
 background:white;
 border-radius:50%;
 margin:auto;
 opacity:0;
}

/* 6 m·∫∑t */
.face1{transform:rotateY(0deg) translateZ(var(--dice-depth));}
.face2{transform:rotateY(180deg) translateZ(var(--dice-depth));}
.face3{transform:rotateY(90deg) translateZ(var(--dice-depth));}
.face4{transform:rotateY(-90deg) translateZ(var(--dice-depth));}
.face5{transform:rotateX(90deg) translateZ(var(--dice-depth));}
.face6{transform:rotateX(-90deg) translateZ(var(--dice-depth));}

@keyframes rollX {
 from { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
 to   { transform: rotateX(1080deg) rotateY(360deg) rotateZ(720deg); }
}

@keyframes rollY {
 from { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
 to   { transform: rotateX(360deg) rotateY(1080deg) rotateZ(720deg); }
}

@keyframes rollZ {
 from { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
 to   { transform: rotateX(720deg) rotateY(360deg) rotateZ(1080deg); }
}

@keyframes rollChaos {
 from { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
 to   { transform: rotateX(900deg) rotateY(1200deg) rotateZ(600deg); }
}
.bet-ui{
 margin-top:6px;
 display:flex;
 flex-direction:column;
 gap:4px;
}

.bet-action{
 background:#ffd700;
 color:#000;
 border-radius:6px;
 padding:6px;
 font-weight:bold;
 cursor:pointer;
}

.bet-working{
 background:#fff;
 color:#000;
 border-radius:6px;
 padding:6px;
 font-weight:bold;
}

.bet-final{
 font-size:13px;
 color:#0f0;
}
.money-pop{
 animation: moneyPop 0.45s ease-out;
 display:inline-block;
}

@keyframes moneyPop{
 0%   { transform: scale(1); }
 40%  { transform: scale(1.20); }
 100% { transform: scale(1); }
}
html, body{
 margin:0;
 padding:0;
 width:100%;
 height:100%;
 background:#0b0f1a;
 overflow:hidden;
}

#app{
 width:100vw;
 height:100vh;
 display:flex;
 justify-content:center;
 align-items:center;
 overflow:hidden;
}

/* Khung thi·∫øt k·∫ø g·ªëc (mobile portrait) */
#gameScale{
 width:420px;
 height:760px; /* ~ t·ªâ l·ªá 9:16 */
 transform-origin: top center;
}
</style>
</head>

<body>
<div id="app">
  <div id="gameScale">
    <div class="board">
<div id="coinLayer"></div>

<div class="top-left">
<button onclick="deposit()">üí∞N·∫†P TI·ªÄN</button>
</div>
<div class="top-right">
<button onclick="toggleSessionHistory()">üìäSOI C·∫¶U</button>
<button onclick="toggleBetHistory()">üìú L·ªäCH S·ª¨</button>
    
<button onclick="toggleRank()">üèÜ BXH</button>
</div>



<div class="money">üíµS·ªê D∆Ø: <span id="money">100,000,000,000</span></div>
<div style="margin:6px 0;color:#ffd700;font-weight:bold">
 üé∞ H≈®: <span id="jackpot">0</span>
</div>
<div>C·ª≠a ƒë·∫∑t: <span id="mySide">‚Äì</span> | Ti·ªÅn c∆∞·ª£c: <span id="myBet">0</span></div>

<div class="bet-area">

<!-- T√ÄI -->
<div class="side tai" id="taiBox">
 <div>T√ÄI</div>
 <div>üí∞ <span id="taiTotal">0</span></div>
 <div>üë§ <span id="taiPeople">0</span></div>

 <div class="bet-ui">
  <div class="bet-action" id="taiAction" onclick="openBetPanel('tai')">C∆Ø·ª¢C</div>
  <div class="bet-final">0</div>
 </div>
</div>

<!-- X·ªàU -->
<div class="side xiu" id="xiuBox">
 <div>X·ªàU</div>
 <div>üí∞ <span id="xiuTotal">0</span></div>
 <div>üë§ <span id="xiuPeople">0</span></div>

 <div class="bet-ui">
  <div class="bet-action" id="xiuAction" onclick="openBetPanel('xiu')">C∆Ø·ª¢C</div>
  <div class="bet-final">0</div>
 </div>
</div>

</div>

<div class="center" id="center">
  <div id="bowl" class="bowl hidden">üü§</div>
</div>

<div id="betPanel" class="hidden">
 <button onclick="addTempBet(10000)">10K</button>
 <button onclick="addTempBet(50000)">50K</button>
 <button onclick="addTempBet(1000000)">1M</button>
 <button onclick="addTempBet(50000000)">50M</button>
 <button onclick="addTempBet(1000000000)">1B</button>
 <button onclick="addTempBet(50000000000)">50B</button>
 <button onclick="tempAllIn()">ALL IN</button><br>
 <button onclick="confirmBet()">ƒê·∫∂T C∆Ø·ª¢C</button>
 <button onclick="closeBetPanel()">HU·ª∂</button>
</div>

<div id="result"></div>
<div class="history" id="history"></div>
<div id="sessionHistoryBox" class="hidden">

 <!-- HEADER TAB -->
 <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
  <div id="sessionTitle" style="font-weight:bold">üìä BI·ªÇU ƒê·ªí PHI√äN</div>
  <div>
   <button onclick="prevSessionPage()">‚óÄ</button>
   <button onclick="nextSessionPage()">‚ñ∂</button>
  </div>
 </div>

 <!-- PAGE 1 -->
 <div id="sessionPage1">
 <div id="sessionInfo" style="font-size:13px;font-weight:bold;margin-bottom:6px;"></div>
<canvas id="sessionCanvas" width="360" height="200"></canvas>
 </div>

 <!-- PAGE 2 -->
 <div id="sessionPage2" class="hidden">

  <div class="stats" style="display:flex;gap:10px;justify-content:center;margin-bottom:6px;">
   <div id="roadTaiCount" class="stat tai">T√†i: 0</div>
   <div id="roadXiuCount" class="stat xiu">X·ªâu: 0</div>
  </div>

  <div id="roadGrid" class="grid"></div>

 </div>

</div>
<div id="betHistoryBox"></div>
<!-- B·∫¢NG X·∫æP H·∫†NG -->
<div id="rankBox">
 <div class="rank-title">üèÜ B·∫¢NG X·∫æP H·∫†NG</div>
 <table>
  <thead>
   <tr>
    <th>#</th>
    <th>T√†i kho·∫£n</th>
    <th>Ti·ªÅn th·∫Øng</th>
   </tr>
  </thead>
  <tbody id="rankBody"></tbody>
 </table>
</div>
<div id="chatBox"></div>
<div class="chat-input">
 <input id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeydown="if(event.key==='Enter')sendChat()">
 <button onclick="sendChat()">G·ª¨I</button>
</div>

</div>

<script>
let bowlTimerInterval = null;

function spawnBowlTimer(seconds = 15){
 const center = $("center");

 // xo√° timer c≈© n·∫øu c√≤n
 const old = document.getElementById("bowlTimer");
 if(old) old.remove();
 if(bowlTimerInterval) clearInterval(bowlTimerInterval);

 const t = document.createElement("div");
 t.id = "bowlTimer";
 t.className = "bowl-timer";
 t.textContent = seconds;
 center.appendChild(t);

 let s = seconds;
 bowlTimerInterval = setInterval(()=>{
  s--;
  if(s <= 0){
   clearInterval(bowlTimerInterval);
   t.remove();
  }else{
   t.textContent = s;
  }
 },1000);
}
function popMoneyById(id){
 const el = document.getElementById(id);
 el.classList.remove("money-pop");
 void el.offsetWidth;
 el.classList.add("money-pop");
}
function openBetPanel(side){
 if(lockBet) return;

 // n·∫øu ƒë√£ confirm c·ª≠a kh√°c r·ªìi ‚Üí ch·∫∑n
 if(lockedSide && lockedSide !== side){
  alert("B·∫°n ch·ªâ ƒë∆∞·ª£c ƒë·∫∑t 1 c·ª≠a trong phi√™n n√†y!");
  return;
 }

 // n·∫øu ƒëang m·ªü panel b√™n kia ‚Üí reset UI b√™n kia
 if(activeSide && activeSide !== side){
  resetWorkingUI(activeSide);
 }

 activeSide = side;
 tempBet = 0;

 $("betPanel").classList.remove("hidden");
 updateWorkingUI();
}

function closeBetPanel(){
 if(activeSide){
  resetWorkingUI(activeSide);
 }
 activeSide = null;
 tempBet = 0;
 $("betPanel").classList.add("hidden");
}

function addTempBet(v){
 if(!activeSide) return;
 if(tempBet + v > money) return;
 tempBet += v;
 updateWorkingUI();
}

function tempAllIn(){
 if(!activeSide) return;
 tempBet = money;
 updateWorkingUI();
}
function popMoney(el){
 el.classList.remove("money-pop");
 void el.offsetWidth; // force reflow
 el.classList.add("money-pop");
}
function confirmBet(){
 if(lockBet){
  alert("ƒê√£ h·∫øt th·ªùi gian ƒë·∫∑t c∆∞·ª£c!");
  closeBetPanel();
  return;
 }

 if(!activeSide || tempBet <= 0) return;
 if(money < tempBet) return;

 money -= tempBet;
/* ===== CHAT TH√îNG B√ÅO C∆Ø·ª¢C L·ªöN ===== */
if(tempBet >= 50000000){
 pushChat("admin", `üíé ƒê·∫°i gia ƒê·ª®C DUY v·ª´a c∆∞·ª£c ${tempBet.toLocaleString()} v√†o ${activeSide.toUpperCase()}!`);

 const praise = [
  "Vcl tay to g·ªõm!",
  "Nh√† c√°i ƒë√°i r·ªìi ‚ò†Ô∏è",
  "B√°n nh√† ƒë√°nh tay k·∫øt n√†y √† ü§£",
  "C·∫ßu n√†y m√† g√£y ch·∫Øc ·ªâa ra qu·∫ßn",
  "b√∫ r·ªìi anh em ∆°i üí∞",
  "Tay n√†y m√† ƒÉn ch·∫Øc s·∫≠p game"
 ];

 let count = 1 + (Math.random()*2 | 0);
 for(let i=0;i<count;i++){
  setTimeout(()=>{
   pushChat("admin", praise[Math.random()*praise.length|0]);
  }, 500 + i*600);
 }
}
/* ===== END CHAT C∆Ø·ª¢C L·ªöN ===== */
 bet += tempBet;
 side = activeSide;

 if(!lockedSide) lockedSide = activeSide;

 if(side === "tai"){
  taiTotal += tempBet;
  taiP++;
 }else{
  xiuTotal += tempBet;
  xiuP++;
 }

 const finalEl = document.querySelector(`#${side}Box .bet-final`);
 finalEl.textContent = bet.toLocaleString();

 closeBetPanel();
 ui();
}

function updateWorkingUI(){
 const el = document.getElementById(activeSide + "Action");
 el.className = "bet-working";
 el.textContent = tempBet.toLocaleString();
}

function resetWorkingUI(side){
 const el = document.getElementById(side + "Action");
 el.className = "bet-action";
 el.textContent = "C∆Ø·ª¢C";
}
function showWinFloat(amount, isJackpot = false){
 const center = document.getElementById("center");
 const rect = center.getBoundingClientRect();

 const el = document.createElement("div");
 el.className = "win-float" + (isJackpot ? " jackpot" : "");
 el.textContent = "+" + amount.toLocaleString();

 el.style.left = rect.width / 2 + "px";
 el.style.top  = rect.height / 2 + "px";

 center.appendChild(el);
 setTimeout(()=>el.remove(), 4100);
}
function flowCoinsTo(targetEl, streamTime = 1200){
 const layer = document.getElementById("coinLayer");
 const layerRect = layer.getBoundingClientRect();
 const targetRect = targetEl.getBoundingClientRect();

 const endX = targetRect.left + targetRect.width/2 - layerRect.left;
 const endY = targetRect.top  + targetRect.height/2 - layerRect.top;

 const startTime = performance.now();
 const interval = 50;

 const timer = setInterval(()=>{
  if(performance.now() - startTime > streamTime){
   clearInterval(timer);
   return;
  }
  spawnBezierCoinLocal(layer, endX, endY);
 }, interval);
}

function spawnBezierCoinLocal(layer, endX, endY){
 const coin = document.createElement("div");
 coin.className = "coin";
 layer.appendChild(coin);

 const startX = layer.clientWidth/2 + (Math.random()*120 - 60);
 const startY = -30;

 const controlX = (startX + endX)/2 + (Math.random()*160 - 80);
 const controlY = startY + 260 + Math.random()*120;

 const duration = 900 + Math.random()*300;
 const start = performance.now();

 function animate(now){
  const t = Math.min((now - start)/duration, 1);

  const x = (1-t)*(1-t)*startX + 2*(1-t)*t*controlX + t*t*endX;
  const y = (1-t)*(1-t)*startY + 2*(1-t)*t*controlY + t*t*endY;

  coin.style.left = x + "px";
  coin.style.top  = y + "px";
  coin.style.transform = `rotate(${t*720}deg) scale(${0.7 + t*0.3})`;

  if(t < 1) requestAnimationFrame(animate);
  else coin.remove();
 }

 requestAnimationFrame(animate);
}
function streamCoinsTo(targetEl, duration = 1200){
 const target = targetEl.getBoundingClientRect();
 const endX = target.left + target.width / 2;
 const endY = target.top  + target.height / 2;

 const streamInterval = 60; // ms ‚Äî m·∫≠t ƒë·ªô d√≤ng
 const startTime = performance.now();

 const timer = setInterval(()=>{
  const now = performance.now();
  if(now - startTime > duration){
   clearInterval(timer);
   return;
  }

  const coin = document.createElement("div");
  coin.className = "coin";
  document.body.appendChild(coin);

  const startX = Math.random() * window.innerWidth;
  const dropY = target.top + 40 + Math.random()*40;

  coin.style.left = startX + "px";
  coin.style.top  = "-30px";
  coin.style.setProperty("--drop", dropY + "px");

  // 1Ô∏è‚É£ R∆°i th√†nh d√≤ng
  coin.style.animation = `coinStreamDrop 0.6s linear forwards`;

  // 2Ô∏è‚É£ Sau khi r∆°i ‚Üí ch·∫£y v·ªÅ c·ª≠a th·∫Øng
  setTimeout(()=>{
   const rect = coin.getBoundingClientRect();
   const dx = endX - rect.left;
   const dy = endY - rect.top;

   coin.style.setProperty("--dx", dx + "px");
   coin.style.setProperty("--dy", dy + "px");

   coin.style.animation = `coinFlowToBox 0.7s cubic-bezier(.2,.8,.3,1) forwards`;
  }, 620);

  setTimeout(()=>coin.remove(), 1400);
 }, streamInterval);
}
function rainCoinsTo(targetEl, count = 24){
 const target = targetEl.getBoundingClientRect();
 const endX = target.left + target.width / 2;
 const endY = target.top  + target.height / 2;

 for(let i = 0; i < count; i++){
  const coin = document.createElement("div");
  coin.className = "coin";
  document.body.appendChild(coin);

  const startX = Math.random() * window.innerWidth;
  const drop = target.top + Math.random()*40;

  coin.style.left = startX + "px";
  coin.style.setProperty("--drop", drop + "px");

  // 1Ô∏è‚É£ R∆°i xu·ªëng
  coin.style.animation = `coinDrop 0.6s ease-out forwards`;
  coin.style.animationDelay = (Math.random()*0.2) + "s";

  // 2Ô∏è‚É£ Bay v·ªÅ c·ª≠a th·∫Øng
  setTimeout(()=>{
   const rect = coin.getBoundingClientRect();
   const dx = endX - rect.left;
   const dy = endY - rect.top;

   coin.style.setProperty("--dx", dx + "px");
   coin.style.setProperty("--dy", dy + "px");

   coin.style.animation = `coinFlyToBox 0.7s cubic-bezier(.2,.8,.3,1) forwards`;
  }, 650);

  setTimeout(()=>coin.remove(), 1500);
 }
}

function makeFace(n){
 let f = document.createElement("div");
 f.className = "face";

 let layout = {
  1:[4],
  2:[0,8],
  3:[0,4,8],
  4:[0,2,6,8],
  5:[0,2,4,6,8],
  6:[0,2,3,5,6,8]
 }[n];

 for(let i=0;i<9;i++){
  let d = document.createElement("div");
  d.className = "dot";
  if(!layout.includes(i)) d.style.visibility = "hidden";
  f.appendChild(d);
 }
 return f;
}

function drawDice3D(num, rolling=false){
 let d = document.createElement("div");
 d.className = "dice3d";
 if(rolling) d.classList.add("rolling");

 for(let i=1;i<=6;i++){
  let f = makeFace(i);
  f.classList.add("f"+i);
  d.appendChild(f);
 }

 if(!rolling){
  let rot = {
   1:"rotateY(0deg)",
   2:"rotateY(-90deg)",
   3:"rotateY(180deg)",
   4:"rotateY(90deg)",
   5:"rotateX(-90deg)",
   6:"rotateX(90deg)"
  }[num];
  d.style.transform = rot;
 }

 return d;
}
function rollRandomDice(){
 let c = $("center");
 c.innerHTML = "";
 c.append(
  drawDice3D(1,true),
  drawDice3D(1,true),
  drawDice3D(1,true)
 );
}

function startRolling(duration, callback){
 let t = setInterval(rollRandomDice, 120);
 setTimeout(()=>{
  clearInterval(t);
  callback();
 }, duration);
}
let jackpotRate = 0.1; // 10%
const $=id=>document.getElementById(id);
/* ===== ROADMAP T√ÄI X·ªàU ===== */
const ROAD_COLS = 15;
const ROAD_ROWS = 5;
const roadGrid = document.getElementById("roadGrid");

for(let i=0;i<ROAD_COLS*ROAD_ROWS;i++){
 const d = document.createElement("div");
 d.className = "cell";
 roadGrid.appendChild(d);
}

let roadColumns = [];
let roadLastType = null;
let roadmapInitialized = false;
function initRandomRoadmapBackground(){
 roadColumns = [];
 roadLastType = null;

 const totalCells = ROAD_COLS * ROAD_ROWS;
 const fakeCount = totalCells - history.length;

 const fake = genRandomRoad(fakeCount);
 fake.forEach(item => addRoadResult(item.total));
}
function renderRoadmap(){
 [...roadGrid.children].forEach(c => c.innerHTML = "");

 let tai = 0;
 let xiu = 0;

 roadColumns.forEach((colData, c)=>{
  colData.forEach((item, r)=>{
   const index = r * ROAD_COLS + c;
   const cell = roadGrid.children[index];
   if(!cell) return;

   const ball = document.createElement("div");
   ball.className = "ball " + item.type;
   ball.textContent = item.num;
   cell.appendChild(ball);

   if(item.type === "tai") tai++;
   else xiu++;
  });
 });

 document.getElementById("roadTaiCount").textContent = "T√†i: " + tai;
 document.getElementById("roadXiuCount").textContent = "X·ªâu: " + xiu;
}
function addRoadResult(num){
 const type = num >= 11 ? "tai" : "xiu";

 if(roadColumns.length === 0){
  roadColumns.push([{num, type}]);
 }else{
  const lastCol = roadColumns[roadColumns.length - 1];

  if(type === roadLastType){
   if(lastCol.length < ROAD_ROWS){
    lastCol.push({num, type});
   }else{
    roadColumns.push([{num, type}]);
   }
  }else{
   roadColumns.push([{num, type}]);
  }
 }

 if(roadColumns.length > ROAD_COLS){
  roadColumns.shift();
 }

 roadLastType = type;
}
function syncRoadmapFromHistory(){
 if(!roadmapInitialized){
  // üëâ L·∫ßn ƒë·∫ßu: random n·ªÅn + ƒë·ªï 20 phi√™n th·∫≠t v√†o cu·ªëi
  initRandomRoadmapBackground();
  history.forEach(h => addRoadResult(h.total));
  roadmapInitialized = true;
 }else{
  // üëâ C√°c l·∫ßn sau: ch·ªâ th√™m k·∫øt qu·∫£ m·ªõi nh·∫•t
  const last = history[history.length - 1];
  if(last){
   addRoadResult(last.total);
  }
 }

 renderRoadmap();
}
let money=100000000000,bet=0,side=null;
let taiTotal=0,xiuTotal=0,taiP=0,xiuP=0;
let time=31,lockBet=false,chatOn=true;
let jackpot = 100000000 + Math.random()*200000000 | 0;
let history = [];
let sessionNumber = 1000000 + Math.random() * 900000 | 0; // 1xxxxxx
 let tempBet = 0;
let activeSide = null;
let lockedSide = null; // c·ª≠a ƒë√£ ch·ªçn trong phi√™n
// m·ªói ph·∫ßn t·ª≠ c√≥ d·∫°ng: { total: 12, side: "tai" }
// üé≤ RANDOM S·∫¥N 15‚Äì20 PHI√äN (GI·∫¢ L·∫¨P GAME ƒê√É CH·∫†Y)
/* ===== ü§ñ BOT ƒê·∫†I GIA 1 L·∫¶N / PHI√äN (SAFE) ===== */
function whaleBotBet(){
 if(lockBet) return;

 const amount = Math.floor(200000000 + Math.random() * 1000000000); // 30‚Äì70 t·ª∑
 const side = Math.random() < 0.5 ? "tai" : "xiu";

 if(side === "tai"){
  taiTotal += amount;
  taiP++;
 }else{
  xiuTotal += amount;
  xiuP++;
 }

 ui();
 pushChat("admin", `üíé ƒê·∫°i gia v·ª´a c∆∞·ª£c ${amount.toLocaleString()} v√†o ${side.toUpperCase()}!`);
}

function scheduleWhaleBot(){
 const delay = 1000 + Math.random() * 20000; // random th·ªùi ƒëi·ªÉm trong phi√™n
 setTimeout(whaleBotBet, delay);
}
function initFakeHistory(){
 history = [];
 let count = 20;

 for(let i = 0; i < count; i++){
  let side = Math.random() < 0.5 ? "tai" : "xiu";
  let total = side === "tai"
    ? 11 + (Math.random()*7 | 0)
    : 4  + (Math.random()*7 | 0);

  history.push({
   session: sessionNumber++,
   total: total,
   side: side,
   dice: side === "tai"
    ? [5,3,3]
    : [2,3,3]
  });
 }

 renderHistory();
 drawSessionHistory();
 syncRoadmapFromHistory();
}


/* L·ªäCH S·ª¨ C∆Ø·ª¢C */
let betHistoryLog=[];
let roundIndex=0;

let lastTaiTotal = 0;
let lastXiuTotal = 0;

function ui(){
 $("jackpot").textContent = jackpot.toLocaleString();
 $("money").textContent = money.toLocaleString();
 $("mySide").textContent = side || "‚Äì";
 $("myBet").textContent = bet.toLocaleString();

 // ---- ZOOM TI·ªÄN ----
 if(taiTotal !== lastTaiTotal){
 $("taiTotal").textContent = taiTotal.toLocaleString();
  popMoneyById("taiTotal");
 }else{
  $("taiTotal").textContent = taiTotal.toLocaleString();
 }

 if(xiuTotal !== lastXiuTotal){
$("xiuTotal").textContent = xiuTotal.toLocaleString();
  popMoneyById("xiuTotal");
 }else{
  $("xiuTotal").textContent = xiuTotal.toLocaleString();
 }
 // -------------------

 lastTaiTotal = taiTotal;
 lastXiuTotal = xiuTotal;

 $("taiPeople").textContent = taiP;
 $("xiuPeople").textContent = xiuP;
}
function deposit(){
 let v=+prompt("Nh·∫≠p s·ªë ti·ªÅn mu·ªën n·∫°p:");
 if(v>0){money+=v;ui();}
}

function addBet(v){$("bet").value=+$("bet").value+v}
function allIn(){$("bet").value=money}

function place(s){
 if(lockBet) return alert("ƒê√£ kho√° c∆∞·ª£c!");
 let v=+$("bet").value;
 if(v<=0||v>money) return;
 money-=v; bet+=v;/* ===== CHAT ƒê·∫†I GIA C∆Ø·ª¢C L·ªöN ===== */
if(v >= 50000000){
  // Th√¥ng b√°o ƒë·∫°i gia
  pushChat("admin", `üíé ƒê·∫°i gia ƒê·ª©c Duy ƒë√£ c∆∞·ª£c ${v.toLocaleString()} üí∞`);

  // C√°c c√¢u khen/ng·∫°c nhi√™n
  const praise = [
    "Vcl Duy m·∫°nh th√≠ü•∂!",
    "B√°n nh√† ƒë√°nh tay k·∫øt √† Duy ü§£",
    "Nh√† c√°i kh√¥ng b·ªãp ae m·∫•y ƒë·ªìng l·∫ª l√†m g√¨ c·∫£ ƒë√¢u",
    "C·ªù b·∫°c ng∆∞·ªùi th·∫Øng l√† ng∆∞·ªùi bi·∫øt ƒëi·ªÉm d·ª´ng nh√©ü•∞",
    "M·∫•y ƒë·ª©a c·ª© b√¨nh tƒ©nh, m·ªói phi√™n anh s·∫Ω h√¥ cho 1 tay",
    "Ch√∫c ng∆∞·ªùi ae th·∫Øng l·ªõn nh√©üí∞üí∞üí∞"
  ];

  // Random 1‚Äì2 c√¢u chat
  let count = 1 + (Math.random() * 2 | 0);
  for(let i=0;i<count;i++){
    setTimeout(()=>{
      let msg = praise[Math.random()*praise.length|0];
      pushChat("admin", msg);
    }, 500 + i*600);
  }
}
/* ===== END CHAT ƒê·∫†I GIA ===== */ side=s;
 if(s=="tai"){taiTotal+=v;taiP++}else{xiuTotal+=v;xiuP++}
 $("bet").value=0; ui();
}

function cancelBet(){
 if(!side) return;
 money+=bet;
 if(side=="tai"){taiTotal-=bet;taiP--}
 else{xiuTotal-=bet;xiuP--}
 bet=0; side=null; ui();
}

function drawDice(n){
 const map={1:[4],2:[0,8],3:[0,4,8],4:[0,2,6,8],5:[0,2,4,6,8],6:[0,2,3,5,6,8]};
 let d=document.createElement("div"); d.className="dice";
 for(let i=0;i<9;i++){
  let p=document.createElement("div");
  p.className="dot";
  if(map[n].includes(i)) p.style.opacity=1;
  d.appendChild(p)
 }
 return d;
}
function drawDice3D(n, rolling=false){
 if(!rolling){
  let wrap = document.createElement("div");
  wrap.className = "dice3d";

  let flat = drawDice(n);
  flat.style.transform = "translate(-50%, -50%) rotate(135deg)";
  flat.style.position = "absolute";
  flat.style.left = "50%";
  flat.style.top = "50%";

  wrap.appendChild(flat);
  return wrap;
 }

 // --- ph·∫ßn 3D gi·ªØ nguy√™n ---
 const map={
 1:[4],2:[0,8],3:[0,4,8],4:[0,2,6,8],5:[0,2,4,6,8],6:[0,2,3,5,6,8]
 };

 let dice=document.createElement("div");
 dice.className="dice3d rolling";

 for(let i=1;i<=6;i++){
  let face=document.createElement("div");
  face.className="face face"+i;

  for(let j=0;j<9;j++){
   let d=document.createElement("div");
   d.className="dot";
   if(map[i].includes(j)) d.style.opacity=1;
   face.appendChild(d);
  }
  dice.appendChild(face);
 }

 const anims=["rollX","rollY","rollZ","rollChaos"];
 dice.style.animation = anims[Math.random()*anims.length|0] + " 1.2s linear infinite";

 return dice;
}

function renderHistory(){
 $("history").innerHTML = "";
 history.forEach(h=>{
  let d = document.createElement("div");
  d.className = "dotH " + h.side; // tai = ƒëen | xiu = tr·∫Øng
  $("history").appendChild(d);
 });
}
/* CHAT */
const names=["Anh ƒê·ªô Skibidi", "Kh√° B·∫£nh","Th·ªëng Tr·ªã B√†n C·ªù","ƒê·ªïi ƒë·ªùi nƒÉm 2026","Vua C·ªù B·∫°c","Trung M√°y C√†y","Ronaldo","Kh√°nh B√∫a","Messi","ƒê·ª©a con t·ªôi l·ªóiüòû","C·ªù gian b·∫°c b·ªãp","Sunwin m√£i ƒë·ªânh","V·ª´a ·ªâa v·ª´a g√µ"];
const predicts=["ƒê√°nh tx l√†m loll g√¨, ƒë·∫ßu t∆∞ HDPE th√¨ ngon lu√¥n","Ti·ªÅn ƒë·ªëi v·ªõi t ch·ªâ l√† nh·ªØng con s·ªë","C·∫ßu b·ªát 36 con t√†i n√®","C·∫ßu n√†y d·ªÖ c√∫t","Tao c·∫Øm xe lu√¥n r·ªìi game ∆°iüò≠","S·∫Ω c√≥ nh·ªØng con ch√≥ ph·∫£i tr·∫£ gi√°","Ng·ªìi ƒë√¢y h√≥ng m·∫•y con nghi·ªán c·ªù b·∫°c ch·ª≠i nhauü§£","ƒë·ªãt m·∫π game l","ƒê√°nh c√≥ 10k soi soi cmm √† game","Kh√¥ng x·ªâu ch·∫∑t cu","Ra t√†i xo√° game","M·∫π cho 7m ƒë√≥ng h·ªçc m√† 3 tay ƒë√£ c√∫t dcmüòû","ƒê·ª£i Duy h√¥ c·∫ßu h·∫µng ƒë√°nh ae","ngu m·ªõi ƒëi x·ªâuüòÜ","Theo T√†i c√≥ m√† b√°n nh√†","Sao n·∫°p ti·ªÅn l√¢u v√†o th·∫ø mn","Do m√†y ngu th√¥i tr√°ch aiü§£","N·ªët tay ngh·ªâ ","ƒê·ªÉ anh h√¥ cho","√îng th√¨ bi·∫øt c√°i dell g√¨","M·ªõi b√∫ 10m th∆°m ph·ª©c","Xin l·ªôc v·ªõi mn","ib zalo:0965132226 h·ªó tr·ª£ k√©o c·∫ßu v·ªÅ b·ªù","V·ªÅ b·ªù r·ªìi ae","Ra ƒë√™ m√† ·ªü","B·ªë ƒë·ªãt v√†o m·∫∑t th·∫±ng Admin lu√¥n ƒë·∫•y","30s cho 1 cu·ªôc t√¨nh"];
const wins=["Haha ƒÉn r·ªìi","ƒê√∫ng c·∫ßu nh√©","Li·∫ømüòãüòãüòã","√îi b√∫ ƒë·∫´m"];
const loses=["Cay th·∫≠t","Theo Duy th√¨ kh√¥ng theo","Game l","M·∫•t ti·ªÅn tay v·ªãn t·ªëi nay lu√¥n"];

function pushChat(type, custom){
 if(!chatOn) return;
 let box=$("chatBox");
 let div=document.createElement("div");

 if(type==="me"){
  div.className="chat-msg me";
  div.innerHTML=`<span class="nick me">B·∫°n:</span> ${custom}`;
 }
 else if(type==="admin"){
  div.className="chat-msg predict";
  div.innerHTML=`<span class="nick admin">ADMIN:</span> ${custom}`;
 }
 else{
  let n=names[Math.random()*names.length|0];
  let msg="",cls="";
  if(type=="predict"){msg=predicts[Math.random()*predicts.length|0];cls="predict"}
  if(type=="win"){msg=wins[Math.random()*wins.length|0];cls="winChat"}
  if(type=="lose"){msg=loses[Math.random()*loses.length|0];cls="loseChat"}
  div.className="chat-msg "+cls;
  div.innerHTML=`<span class="nick">${n}:</span> ${msg}`;
 }

 box.appendChild(div);
 box.scrollTop=box.scrollHeight;
 if(box.children.length>30) box.removeChild(box.firstChild);
}

function sendChat(){
 let v=$("chatInput").value.trim();
 if(!v) return;
 $("chatInput").value="";
 pushChat("me", v);
}

setInterval(()=>{
 if(time<=3){pushChat("predict"); pushChat("predict")}
 else if(Math.random()<0.7) pushChat("predict");
},1200);

/* ROUND */
function round(){
 roundIndex++;
 scheduleWhaleBot(); // ü§ñ bot ƒë·∫°i gia b·∫Øt ƒë·∫ßu c∆∞·ª£c
 time=31; bet=0; side=null; lockBet=false;
tempBet = 0;
activeSide = null;
lockedSide = null;
resetWorkingUI("tai");
resetWorkingUI("xiu");
document.querySelector("#taiBox .bet-final").textContent = "0";
document.querySelector("#xiuBox .bet-final").textContent = "0";
 taiTotal=0; xiuTotal=0;
 taiP=Math.random()*500|0; xiuP=Math.random()*500|0;
 $("result").textContent="";

 let adminPick=Math.random()<0.5?"T√ÄI":"X·ªàU";
 pushChat("admin",`D·ª± ƒëo√°n phi√™n n√†y v·ªÅ ${adminPick}`);

 let t=setInterval(()=>{
$("center").innerHTML = `<div class="countdown">${--time}</div>`;


 // üîí CH·ªà BOT C∆Ø·ª¢C KHI CH∆ØA KH√ìA
 if(time > 5){
  taiTotal += Math.random()*2e8 | 0;
  xiuTotal += Math.random()*2e8 | 0;
  taiP += Math.random()*230 | 0;
  xiuP += Math.random()*230 | 0;
 }

 // ‚õî KHO√Å C∆Ø·ª¢C 5 GI√ÇY CU·ªêI
 if(time <= 5){
 lockBet = true;
 closeBetPanel(); // üîí √©p ƒë√≥ng b·∫£ng c∆∞·ª£c n·∫øu ƒëang m·ªü
 $("result").innerHTML = "<span class='lock'>‚õî D·ª™NG C∆Ø·ª¢C</span>";
}

 ui();

 if(time <= 0){
  clearInterval(t);
  end();
 }
},1000);
}
function end(){
 let totalBet = taiTotal + xiuTotal;
 let addJackpot = Math.floor(totalBet * jackpotRate);
 jackpot += Math.max(addJackpot, 10000000);

 let c = $("center");

 // üé≤ Sinh k·∫øt qu·∫£
 let d1 = 1 + Math.random()*6 | 0;
 let d2 = 1 + Math.random()*6 | 0;
 let d3 = 1 + Math.random()*6 | 0;

 let total = d1 + d2 + d3;
 let win = total >= 11 ? "tai" : "xiu";

 let isJackpot = false;
 if(win === "tai" && total % 2 === 0) isJackpot = true;
 if(win === "xiu" && total % 2 === 1) isJackpot = true;

 history.push({
  session: sessionNumber++,
  total,
  side: win,
  dice: [d1, d2, d3]
 });
 if(history.length > 20) history.shift();

 // üé≤ 1. LƒÉn gi·∫£ 3 gi√¢y
 startRolling(3000, ()=>{

  c.innerHTML = "";

  let wrap = document.createElement("div");
  wrap.className = "dice-wrap";

  let top = drawDice3D(d1);
  let left = drawDice3D(d2);
  let right = drawDice3D(d3);

  wrap.append(top, left, right);
  c.appendChild(wrap);

  requestAnimationFrame(() => {
   const diceSize = top.offsetWidth;
   const rect = c.getBoundingClientRect();
   const cx = rect.width / 2;
   const cy = rect.height / 2;
   const R = rect.width * 0.28;

   function place(el, x, y){
    el.style.left = x - diceSize/2 + "px";
    el.style.top  = y - diceSize/2 + "px";
   }

   place(top,   cx, cy - R);
   place(left,  cx - R * Math.sin(Math.PI/3), cy + R/2);
   place(right, cx + R * Math.sin(Math.PI/3), cy + R/2);
  });

  // üü§ √öp b√°t
  let bowl = document.createElement("div");
  bowl.className = "bowl";
  bowl.textContent = "üü§";
  c.appendChild(bowl);
spawnBowlTimer(14);
  requestAnimationFrame(()=>{
   const rect = c.getBoundingClientRect();
   bowl.style.left = rect.width/2 - bowl.offsetWidth/2 + "px";
   bowl.style.top  = rect.height/2 - bowl.offsetHeight/2 + "px";
  });

  let opened = false;

  function openOnly(){
   if(opened) return;
   opened = true;
   bowl.classList.add("open");
  }

  enableBowlDrag(bowl, openOnly);

  setTimeout(()=>{
   bowl.classList.add("auto-open");
   setTimeout(finalize, 500);
  }, 9000);

  function finalize(){

   // üîî NH·∫§P NH√ÅY C·ª¨A TH·∫ÆNG
   let taiBox = document.querySelector(".side.tai");
   let xiuBox = document.querySelector(".side.xiu");
   taiBox.classList.remove("flash-box");
   xiuBox.classList.remove("flash-box");
   void taiBox.offsetWidth;

   if(win === "tai") taiBox.classList.add("flash-box");
   else xiuBox.classList.add("flash-box");

   if(isJackpot){
    const winBox = win === "tai"
     ? document.getElementById("taiBox")
     : document.getElementById("xiuBox");
    flowCoinsTo(winBox, 1600);
   }

   let status="", cls="", winMoney=0, jackpotWin=0;

   if(side){
    if(side === win){
     winMoney = Math.floor(bet * 1.98);
     money += winMoney;
     myTotalWin += winMoney;
     
     cls = "win";
     pushChat("win");
    }else{
     
     cls = "lose";
     pushChat("lose");
    }
   }

   if(isJackpot){
    let totalWinSide = win==="tai" ? taiTotal : xiuTotal;
    if(side === win && bet > 0 && totalWinSide > 0){
     jackpotWin = Math.floor((bet / totalWinSide) * jackpot);
     money += jackpotWin;
    }
    jackpot = 100000000 + Math.random()*200000000 | 0;
   }

   $("result").innerHTML =
    `K·∫øt qu·∫£: <b>${win.toUpperCase()} ${total}</b><br>
     <b class="${cls}">${status}</b>`;

   let res = $("result");
   res.classList.remove("flash");
   void res.offsetWidth;
   res.classList.add("flash");

   if(side === win && bet > 0){
    let totalGain = winMoney + jackpotWin;
    if(totalGain > 0){
     showWinFloat(totalGain, isJackpot);
    }
   }

   if(bet > 0){
    betHistoryLog.unshift({
     side: side.toUpperCase(),
     result: `${d1}-${d2}-${d3} (${win.toUpperCase()} ${total})`,
     bet: bet,
     win: winMoney
    });
    if(betHistoryLog.length > 30) betHistoryLog.pop();
    renderBetHistory();
   }

   renderHistory();
   drawSessionHistory();
   syncRoadmapFromHistory();
   updateRankData();
   ui();

   setTimeout(round, 3000);
  }
 });
}
function toggleBetHistory(){
 const box = document.getElementById("betHistoryBox");
 box.style.display = box.style.display === "block" ? "none" : "block";
 renderBetHistory();
}
function toggleSessionHistory(){
 let box = document.getElementById("sessionHistoryBox");
 box.classList.toggle("hidden");
 drawSessionHistory();
 syncRoadmapFromHistory();
 showSessionPage();
}

function renderBetHistory(){
 let box=$("betHistoryBox");
 let html="<table><tr><th>#</th><th>C·ª≠a</th><th>K·∫øt qu·∫£</th><th>C∆∞·ª£c</th><th>Th·∫Øng</th></tr>";
 betHistoryLog.forEach((r,i)=>{
  html+=`<tr>
   <td>${i+1}</td>
   <td>${r.side}</td>
   <td>${r.result}</td>
   <td>${r.bet.toLocaleString()}</td>
   <td class="win">${r.win.toLocaleString()}</td>
  </tr>`;
 });
 html+="</table>";
 box.innerHTML=html;
}

function toggleChat(){
 chatOn=!chatOn;
 $("chatBox").style.display=chatOn?"block":"none";
}
/* ===== B·∫¢NG X·∫æP H·∫†NG ===== */
let myTotalWin = 0; // t·ªïng ti·ªÅn th·∫Øng th·∫≠t c·ªßa ƒê·ª©c Duy
let fakeRanks = {}; // l∆∞u ti·ªÅn th·∫Øng bot
let rankData = [];
function toggleRank(){
 let box = $("rankBox");
 box.style.display = box.style.display === "none" ? "block" : "none";
 renderRankUI();
}

function updateRankData(){
 let list = [...names];
 list = list.filter(n => n !== "ƒê·ª©c Duy");
 list.sort(()=>Math.random()-0.5);
 list = list.slice(0,4);

 let rows = list.map(n=>{
  if(!fakeRanks[n]) fakeRanks[n] = Math.random()*5e8 + 5e7;
  fakeRanks[n] += Math.random()*3e8;
  return {name:n, money:Math.floor(fakeRanks[n])};
 });

 // ‚úÖ lu√¥n th√™m ng∆∞·ªùi ch∆°i
 rows.push({
  name: "ƒê·ª©c Duy",
  money: myTotalWin
 });

 rows.sort((a,b)=>b.money-a.money);
 rankData = rows.slice(0,5);
}

function renderRankUI(){
 $("rankBody").innerHTML = "";
 rankData.forEach((r,i)=>{
  let tr = document.createElement("tr");
  let cls = r.name === "ƒê·ª©c Duy" ? "rank-me" : "";
  tr.innerHTML = `
   <td>${i+1}</td>
   <td class="${cls}">${r.name}</td>
   <td class="${cls}">${r.money.toLocaleString()}</td>
  `;
  $("rankBody").appendChild(tr);
 });
}
function enableBowlDrag(bowl, onRelease){
 const center = document.getElementById("center");
 let dragging = false;

 function point(e){
  if(e.touches) return {x:e.touches[0].clientX, y:e.touches[0].clientY};
  return {x:e.clientX, y:e.clientY};
 }

 function start(e){
  e.preventDefault();
  dragging = true;
 }

 function move(e){
  if(!dragging) return;

  const p = point(e);
  const rect = center.getBoundingClientRect();

  const x = p.x - rect.left - bowl.offsetWidth/2;
  const y = p.y - rect.top  - bowl.offsetHeight/2;

  bowl.style.left = x + "px";
  bowl.style.top  = y + "px";

  // ‚úÖ n·∫øu b√°t ra ngo√†i ho√†n to√†n v√≤ng tr√≤n ‚Üí m·ªü
  const bowlRect = bowl.getBoundingClientRect();
  const centerRect = center.getBoundingClientRect();

  const out =
    bowlRect.right < centerRect.left ||
    bowlRect.left  > centerRect.right ||
    bowlRect.bottom < centerRect.top ||
    bowlRect.top > centerRect.bottom;

  if(out){
   dragging = false;
   onRelease && onRelease();
  }
 }

 function end(){
  dragging = false;
 }

 bowl.addEventListener("mousedown", start);
 bowl.addEventListener("touchstart", start, {passive:false});
 window.addEventListener("mousemove", move);
 window.addEventListener("touchmove", move, {passive:false});
 window.addEventListener("mouseup", end);
 window.addEventListener("touchend", end);
}

initFakeHistory(); // üéØ t·∫°o l·ªãch s·ª≠ gi·∫£ tr∆∞·ªõc
ui(); round();
function toggleSessionHistory(){
 let box = document.getElementById("sessionHistoryBox");
 box.classList.toggle("hidden");
 drawSessionHistory();
}
function drawSessionHistory(){

 let cvs = document.getElementById("sessionCanvas");
 if(!cvs) return;

 let ctx = cvs.getContext("2d");
 ctx.clearRect(0,0,cvs.width,cvs.height);

 // ===== HI·ªÇN TH·ªä S·ªê PHI√äN + K·∫æT QU·∫¢ (KH√îNG G√ÇY ƒê∆†) =====
 let info = document.getElementById("sessionInfo");
 if(info && history.length){
  let last = history[history.length - 1];
  info.innerHTML =
 `Phi√™n #<b>${last.session}</b><br>
  üé≤ ${last.dice.join("-")} ‚Üí <b>${last.side.toUpperCase()} ${last.total}</b>`;
}
 if(history.length < 2) return;

 let padding = 25;
 let maxY = 18;
 let minY = 3;

 let stepX = (cvs.width - padding*2) / (history.length - 1);

 // l∆∞·ªõi ngang (3 ‚Äì 6 ‚Äì 9 ‚Äì 12 ‚Äì 15 ‚Äì 18)
 ctx.strokeStyle = "#333";
 ctx.font = "11px Arial";
 ctx.fillStyle = "#aaa";

 for(let y=6;y<=18;y+=3){
  let py = cvs.height - padding - (y-minY)/(maxY-minY)*(cvs.height-padding*2);
  ctx.beginPath();
  ctx.moveTo(padding,py);
  ctx.lineTo(cvs.width-padding,py);
  ctx.stroke();
  ctx.fillText(y, 5, py+4);
 }

 // v·∫Ω ƒë∆∞·ªùng
 ctx.beginPath();
 ctx.lineWidth = 2;
 ctx.strokeStyle = "#ffd700";

 history.forEach((h,i)=>{
  let x = padding + i*stepX;
  let y = cvs.height - padding - (h.total-minY)/(maxY-minY)*(cvs.height-padding*2);

  if(i===0) ctx.moveTo(x,y);
  else ctx.lineTo(x,y);
 });

 ctx.stroke();

 // v·∫Ω ch·∫•m + s·ªë
 history.forEach((h,i)=>{
  let x = padding + i*stepX;
  let y = cvs.height - padding - (h.total-minY)/(maxY-minY)*(cvs.height-padding*2);

  ctx.fillStyle = h.side === "tai" ? "#000" : "#fff";
  ctx.beginPath();
  ctx.arc(x, y, 9, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = h.side === "tai" ? "#fff" : "#000";
  ctx.font = "bold 11px Arial";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(h.total, x, y);
 });
}
let sessionPage = 1;
function showSessionPage(){
 $("sessionPage1").classList.toggle("hidden", sessionPage !== 1);
 $("sessionPage2").classList.toggle("hidden", sessionPage !== 2);
 $("sessionTitle").textContent =
  sessionPage === 1 ? "üìä BI·ªÇU ƒê·ªí PHI√äN" : "üìç B·∫¢NG C·∫¶U ROADMAP";
}

function nextSessionPage(){
 sessionPage = sessionPage === 2 ? 1 : 2;
 showSessionPage();
}

function prevSessionPage(){
 sessionPage = sessionPage === 1 ? 2 : 1;
 showSessionPage();
}
function genRandomRoad(count){
 const fake = [];
 let last = null;

 for(let i=0;i<count;i++){
  const type = Math.random() > 0.5 ? "tai" : "xiu";
  const num = type === "tai"
   ? 11 + Math.floor(Math.random()*7)
   : 4 + Math.floor(Math.random()*6);

  fake.push({ total:num, type });
 }
 return fake;
}
function resizeGame(){
 const baseW = 420;
 const baseH = 760;

 const scale = Math.min(
  window.innerWidth / baseW,
  window.innerHeight / baseH
 );

 const game = document.getElementById("gameScale");
 game.style.transform = `scale(${scale})`;
}

window.addEventListener("resize", resizeGame);
window.addEventListener("orientationchange", resizeGame);
resizeGame();
</script>
    </div>
  </div>
</div>
</body>
</html>
